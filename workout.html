<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>×¤×¨×˜×™ ××™××•×Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Heebo', sans-serif;
        }

        .header-buttons button {
            margin-left: 0.5rem;
        }

        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            border-width: 0.15em;
            margin-right: 0.4rem;
        }

        .workout-card {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.2rem;
            margin-bottom: 1.5rem;
        }

        .exercise-image {
            width: 100%;
            max-width: 300px;
            border-radius: 0.75rem;
            margin-top: 0.75rem;
        }

        /* ===== ××¡×’×¨×ª ×œ×¤×™ ×¡×•×’ ××™××•×Ÿ ===== */
        .workout-card {
            border-right: 8px solid transparent;
        }

        /* ×œ×¤×™ ×¡×•×’ ××™××•×Ÿ */
        .type-cardio {
            border-right-color: #2e7d32;
        }

        .type-core {
            border-right-color: #6a1b9a;
        }

        .type-balance {
            border-right-color: #ef6c00;
        }

        .type-flexibility {
            border-right-color: #039be5;
        }

        .type-strength {
            border-right-color: #b71c1c;
        }


        /* ×‘××¡×›×™× ×’×“×•×œ×™× â€“ × ×§×˜×™×Ÿ ×¢×•×“ */
        @media (min-width: 1200px) {
            .exercise-image {
                max-width: 220px;
            }
        }

        #datePickerContainer {
            display: none;
            margin-top: 0.5rem;
        }

        #updatePopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            z-index: 1000;
            width: 300px;
        }

        #popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        #updatePopup input {
            text-align: center;
        }

        .thumb-gif {
            width: 80px;
            height: auto;
            border-radius: 0.5rem;
            display: block;
        }
    </style>
</head>

<body>
    <div class="container py-4" id="workout-container">
        <div class="text-center text-muted">×˜×•×¢×Ÿ × ×ª×•× ×™ ××™××•×Ÿ...</div>
    </div>

    <div id="popup-overlay"></div>

    <!-- ×¤×•×¤××¤ ×¢×“×›×•×Ÿ ×¡×˜×™× / ×—×–×¨×•×ª / ×¢×•××¡ -->
    <div id="updatePopup">
        <h5 class="mb-3 text-center">×¢×“×›×•×Ÿ ×¡×˜×™× / ×—×–×¨×•×ª / ×¢×•××¡</h5>
        <div class="mb-2">
            <label class="form-label">×¡×˜×™×:</label>
            <input type="number" id="popup-sets" class="form-control" min="1" />
        </div>
        <div class="mb-2">
            <label class="form-label">×—×–×¨×•×ª:</label>
            <input type="number" id="popup-reps" class="form-control" min="1" />
        </div>
        <div class="mb-2">
            <label class="form-label">×–××Ÿ (×©× ×™×•×ª):</label>
            <input type="number" id="popup-time" class="form-control" min="0" step="5" />
        </div>
        <div class="mb-2">
            <label class="form-label">×¢×•××¡:</label>
            <input type="text" id="popup-load" class="form-control" />
        </div>
        <div id="popup-error" class="text-danger small text-center"></div>
        <div class="d-flex justify-content-between mt-3">
            <button id="popup-cancel" class="btn btn-outline-secondary">×‘×˜×œ</button>
            <button id="popup-save" class="btn btn-success">×¢×“×›×Ÿ</button>
        </div>
    </div>

    <!-- âœ… ×¤×•×¤××¤ ×—×“×©: ×”×—×œ×¤×ª ×ª×¨×’×™×œ -->
    <div id="replacePopup" style="display:none; position:fixed; inset:0; z-index:1001;">
        <div
            style="background:white; border-radius:1rem; width:350px; margin:10% auto; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.3)">

            <h5 class="text-center mb-3" id="replacePopupTitle">×‘×—×¨ ×ª×¨×’×™×œ ×—×œ×•×¤×™</h5>


            <div id="exerciseList" style="max-height:300px; overflow-y:auto;"></div>

            <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-outline-secondary" id="replaceCancel">×‘×™×˜×•×œ</button>
                <button class="btn btn-success" id="replaceConfirm">××™×©×•×¨</button>
            </div>

        </div>
    </div>


    <script>
        //const workoutId = 30;
        const urlParams = new URLSearchParams(window.location.search);
        const workoutId = urlParams.get('id');

        let currentItemId = null;
        let allItems = [];


        const repsInput = document.getElementById('popup-reps');
        const timeInput = document.getElementById('popup-time');

        // ×©×™× ×•×™ ×—×–×¨×•×ª -> ×××¤×¡ ×•×× ×˜×¨×œ ×–××Ÿ
        repsInput.addEventListener('input', () => {
            if (repsInput.value !== '') {
                timeInput.value = '';
                timeInput.disabled = true;
            } else {
                timeInput.disabled = false;
            }
        });

        // ×©×™× ×•×™ ×–××Ÿ -> ×××¤×¡ ×•×× ×˜×¨×œ ×—×–×¨×•×ª
        timeInput.addEventListener('input', () => {
            if (timeInput.value !== '') {
                repsInput.value = '';
                repsInput.disabled = true;
            } else {
                repsInput.disabled = false;
            }
        });


        /* ===============================
             ğŸŸ¢ KEEP SCREEN ON 
           =============================== */
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request("screen");

                // ×× ×”××©×ª××© ×¢×‘×¨ ×˜××‘ â€“ iOS ××©×—×¨×¨ ××ª ×–×”, ×¦×¨×™×š ×œ×—×“×©
                wakeLock.addEventListener("release", () => {
                    console.log("Wake Lock released");
                    const toggle = document.getElementById("keepScreenToggle");
                    if (toggle?.checked) {
                        requestWakeLock(); // ×”×¤×¢×œ×” ××—×“×©
                    }
                });

                console.log("Wake Lock Active");
            } catch (err) {
                console.error(`WakeLock error: ${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log("Wake Lock manually released");
            }
        }

        // ×˜×™×¤×•×œ ×‘×˜×•×’×œ
        document.addEventListener("change", (evt) => {
            if (evt.target.id === "keepScreenToggle") {
                if (evt.target.checked) {
                    requestWakeLock();
                } else {
                    releaseWakeLock();
                }
            }
        });

        // ×—×™×“×•×© WakeLock ×× ×”××¡×š "×”×ª×¢×•×¨×¨"
        document.addEventListener("visibilitychange", () => {
            const toggle = document.getElementById("keepScreenToggle");
            if (toggle?.checked && document.visibilityState === "visible") {
                requestWakeLock();
            }
        });


        async function fetchWorkoutDetails() {
            try {
                const endpoint = `https://qwyybhjlpgrrxgpaeigp.supabase.co/functions/v1/get-workout-details?workout_id=${workoutId}&_=${Date.now()}`;

                const res = await axios.get(endpoint);
                if (!res.data || !res.data.workout) throw new Error('×œ× × ××¦××• × ×ª×•× ×™ ××™××•×Ÿ');

                const w = res.data.workout;
                const items = res.data.items || [];

                // âœ… ×–×” ×”×—×œ×§ ×”×§×¨×™×˜×™!
                workout = w;

                renderWorkout(w, items);

            } catch (err) {
                document.getElementById('workout-container').innerHTML =
                    `<div class='alert alert-danger'>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”××™××•×Ÿ</div>`;
                console.error(err);
            }
        }

        function renderWorkout(workout, items) {
            allItems = items; // âœ… ×§×¨×™×˜×™




            const container = document.getElementById('workout-container');
            const workoutDateFormatted = workout.workout_date ? new Date(workout.workout_date).toLocaleDateString('he-IL') : '×œ×œ× ×ª××¨×™×š';
            const workoutDateISO = workout.workout_date ? new Date(workout.workout_date).toISOString().split('T')[0] : '';

            container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 id="workout-name">${workout.name}</h3>
            <div class="text-muted" id="workout-info">${workoutDateFormatted} | ${workout.state}</div>
          </div>
          <div class="header-buttons">
            <button id="status-btn" class="btn btn-outline-success btn-sm">×©× ×” ×¡×˜×˜×•×¡</button>
            <button id="date-btn" class="btn btn-outline-primary btn-sm">×©× ×” ×ª××¨×™×š</button>
            <button id="back-btn" class="btn btn-outline-secondary btn-sm">  â¬… ×—×–×¨×” ×œ×¨×©×™××ª ×”××™××•× ×™×</button>

          </div>
        </div>
    <!-- ğŸŸ¢ ×›×¤×ª×•×¨ KEEP SCREEN ON ×‘××§×•× ×”× ×›×•×Ÿ -->
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="keepScreenToggle">
      <label class="form-check-label" for="keepScreenToggle">
        ğŸ“± ×”×©××¨ ××¡×š ×“×•×œ×§
      </label>
    </div>
        <div id="datePickerContainer">
          <input type="date" id="datePicker" value="${workoutDateISO}" class="form-control form-control-sm" />
          <button id="saveDateBtn" class="btn btn-success btn-sm mt-2">×©××•×¨ ×ª××¨×™×š</button>
        </div>

        ${workout.notes ? `<div class='alert alert-secondary'>${workout.notes}</div>` : ''}

        ${items.map(item => renderItem(item)).join('')}
      `;

            document.getElementById('status-btn').addEventListener('click', changeStatus);
            document.getElementById('date-btn').addEventListener('click', toggleDatePicker);
            document.getElementById('saveDateBtn').addEventListener('click', saveNewDate);

            document.getElementById('popup-cancel').onclick = closePopup;
            document.getElementById('popup-save').onclick = savePopupData;
            document.getElementById('back-btn').addEventListener('click', () => {
                if (workout.state === '×‘×•×¦×¢') {
                    window.location.href = 'complited_workouts.html';
                } else {
                    window.location.href = 'planned_workouts.html';
                }
            });


        }

        function renderItem(item) {
            //console.log("ITEM FULL:", item);
            //console.log("ITEM DATA:", item);

            const e = item.exercise || {};


            const focus = item.focus_area || {};
            const wType = item.workout_type || {};
            const isExercise = e.id != null;
            const title = isExercise ? `${e.name_he}` : `${focus.name_he}`;
            const subtitle = isExercise ? `${e.name_en || ''}` : '';
            const type = `${wType.name_he || ''}`;
            const area = `${focus.name_he || ''}`;
            const unilateralSuffix = item.is_unilateral === true ? " â†”ï¸×œ×›×œ ×¦×“â†”ï¸" : "";
            const volume = item.reps_per_set
                ? `${item.sets}Ã—${item.reps_per_set} ×—×–×¨×•×ª${unilateralSuffix}`
                : `${item.sets}Ã—${item.time_per_set_seconds} ×©× ×™×•×ª${unilateralSuffix}`;
            const load = item.load_used ? `ğŸ‹ï¸ ×¢×•××¡: ${item.load_used}` : '';
            const image = e.default_gif_url || item.gif_url || '';



            return `
        <div class="workout-card type-${(item.workout_type?.code || '').toLowerCase()}">

          <h5>
            <span class="text-muted me-2" style="direction: rtl; unicode-bidi: isolate;">
              ${item.order_in_workout}#
            </span>
            ${title}
          </h5>
          ${subtitle ? `<div class='text-muted small'>${subtitle}</div>` : ''}
          <div>ğŸ§  ${type} | ğŸ¯ ${area}</div>
          <div>ğŸ”¢ ${volume}</div>
          ${load ? `<div>${load}</div>` : ''}

          ${e.default_instructions ? `<div>ğŸ“‹ ${e.default_instructions}</div>` : ''}
          ${image ? `<img src='${image}' alt='${title}' class='exercise-image' />` : ''}
          <div class='mt-3'>
            <button class='btn btn-outline-secondary btn-sm'
        onclick="openReplacePopup(${item.workout_exercise_id})">
  ×”×—×œ×£ ×ª×¨×’×™×œ
</button>

            
	    <button class='btn btn-outline-secondary btn-sm' onclick='openPopup(${item.workout_exercise_id})'>×¢×“×›×Ÿ ×¡×˜×™× / ×—×–×¨×•×ª / ×¢×•××¡</button>

          </div>
        </div>
      `;
        }


        function openPopup(itemId) {
            currentItemId = itemId;
            let selectedExerciseId = null;

            const item = allItems.find(i => i.workout_exercise_id === itemId);
            if (!item) return;

            const setsInput = document.getElementById('popup-sets');
            const repsInput = document.getElementById('popup-reps');
            const timeInput = document.getElementById('popup-time');
            const loadInput = document.getElementById('popup-load');

            // âœ… ××™×¤×•×¡ ××œ× â€“ ×©× ×™ ×”×©×“×•×ª ×ª××™×“ ×¤×ª×•×—×™× ×‘×ª×—×™×œ×”
            repsInput.disabled = false;
            timeInput.disabled = false;

            // ×”×¦×‘×ª ×¢×¨×›×™× ×§×™×™××™×
            setsInput.value = item.sets || 1;
            repsInput.value = item.reps_per_set || '';
            timeInput.value = item.time_per_set_seconds || '';
            loadInput.value = item.load_used || '';
            document.getElementById('popup-error').textContent = '';

            document.getElementById('popup-overlay').style.display = 'block';
            document.getElementById('updatePopup').style.display = 'block';
        }




        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('updatePopup').style.display = 'none';
        }

        async function openReplacePopup(itemId) {
            currentItemId = itemId;
            selectedExerciseId = null;

            const item = allItems.find(i => i.workout_exercise_id === itemId);
            if (!item) return;

            const focus = item.focus_area || {};
            const areaId = focus.id;
            const areaName = focus.name_he || '';

            // ×›×•×ª×¨×ª ×“×™× ××™×ª
            const titleEl = document.getElementById('replacePopupTitle');
            titleEl.textContent = `×‘×—×¨ ×ª×¨×’×™×œ ×—×œ×•×¤×™ â€“ ××–×•×¨ ${areaId}: ${areaName}`;

            const listEl = document.getElementById('exerciseList');
            listEl.innerHTML = "×˜×•×¢×Ÿ ×ª×¨×’×™×œ×™×...";

            try {
                const endpoint = `https://qwyybhjlpgrrxgpaeigp.supabase.co/functions/v1/get-exercises-library?focus_area_id=${areaId}`;
                const res = await axios.get(endpoint);

                const exercises = res.data.exercises || [];

                if (exercises.length === 0) {
                    listEl.innerHTML = "<div class='text-muted text-center'>×œ× × ××¦××• ×ª×¨×’×™×œ×™× ×œ××–×•×¨ ×–×”</div>";
                    return;
                }

                listEl.innerHTML = exercises.map(ex => `
      <label class="border rounded p-2 mb-2 d-flex gap-2 align-items-start w-100"
             style="cursor:pointer">

        <input class="form-check-input mt-1"
               type="radio"
               name="exerciseSelect"
               value="${ex.id}"
               onchange="selectedExerciseId = ${ex.id}"
               style="flex-shrink:0">

        <div>
          <strong>${ex.name_he}</strong>
          <div class="small text-muted">${ex.name_en || ''}</div>

          ${ex.default_gif_url ? `
            <img src="${ex.default_gif_url}"
                 class="thumb-gif mt-1"
                 alt="${ex.name_he}">
          ` : ''}
        </div>

      </label>
    `).join("");

            } catch (err) {
                listEl.innerHTML = "<div class='text-danger text-center'>×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¨×’×™×œ×™×</div>";
                console.error(err);
            }

            document.getElementById('replacePopup').style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'block';
        }



        function closeReplacePopup() {
            document.getElementById('replacePopup').style.display = 'none';
            document.getElementById('popup-overlay').style.display = 'none';
        }

        async function savePopupData() {
            console.log("currentItemId:", currentItemId);


            const btn = document.getElementById('popup-save');
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm';
            btn.prepend(spinner);
            document.getElementById('popup-error').textContent = '';

            const sets = parseInt(document.getElementById('popup-sets').value) || null;
            const repsVal = document.getElementById('popup-reps').value;
            const timeVal = document.getElementById('popup-time').value;

            const reps = repsVal === '' ? null : parseInt(repsVal, 10);
            const time = timeVal === '' ? null : parseInt(timeVal, 10);


            const load = document.getElementById('popup-load').value || null;



            console.log("payload", {
                workout_exercise_id: currentItemId,
                sets,
                reps,
                duration_seconds: time,
                weight: load
            });




            try {
                const endpoint = 'https://qwyybhjlpgrrxgpaeigp.supabase.co/functions/v1/update-workout-exercise-stats';

                const payload = {
                    workout_exercise_id: currentItemId,
                    sets,
                    reps,
                    duration_seconds: time,
                    weight: load
                };

                const res = await axios.post(endpoint, payload);
                if (!res.data || !res.data.success) {
                    throw new Error(res.data?.error || '×¢×“×›×•×Ÿ × ×›×©×œ');
                }

                closePopup();
                await fetchWorkoutDetails();
            } catch (err) {
                document.getElementById('popup-error').textContent = err.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”× ×ª×•× ×™×';
            } finally {
                spinner.remove();
            }
        }

        async function updateWorkoutData(data) {
            const endpoint = 'https://qwyybhjlpgrrxgpaeigp.supabase.co/functions/v1/update-workout';
            const res = await axios.put(endpoint, data);
            if (!res.data || !res.data.success) throw new Error('×¢×“×›×•×Ÿ × ×›×©×œ');
            return res.data;
        }

        async function changeStatus() {

            const currentState = workout.state;
            const newState = currentState === '×‘×•×¦×¢' ? '××ª×•×›× ×Ÿ' : '×‘×•×¦×¢';

            const confirmChange = confirm(`×”×× ×œ×©× ×•×ª ×œ×¡×˜×˜×•×¡ ${newState}?`);
            if (!confirmChange) return;

            const btn = document.getElementById('status-btn');
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm me-2';
            btn.prepend(spinner);

            try {
                await updateWorkoutData({ workout_id: workoutId, state: newState });

                // âœ… ×–×” ×”×—×œ×§ ×”×—×©×•×‘ ×‘×™×•×ª×¨:
                await fetchWorkoutDetails();   // ×¨×¢× ×•×Ÿ ××œ× ××”×©×¨×ª

            } catch (err) {
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡');
                console.error(err);
            } finally {
                spinner.remove();
            }
        }

        function toggleDatePicker() {
            const container = document.getElementById('datePickerContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        async function saveNewDate() {
            const newDate = document.getElementById('datePicker').value;
            if (!newDate) return alert('×× × ×‘×—×¨ ×ª××¨×™×š');

            const btn = document.getElementById('saveDateBtn');
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm';
            btn.prepend(spinner);

            try {
                await updateWorkoutData({ workout_id: workoutId, workout_date: newDate });
                const info = document.getElementById('workout-info');
                const parts = info.textContent.split('|');
                info.textContent = `${newDate.split('-').reverse().join('/')} | ${parts[1].trim()}`;
                alert('×”×ª××¨×™×š ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
            } catch (err) {
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×ª××¨×™×š');
            } finally {
                spinner.remove();
            }
        }


        // ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™ ×¤×•×¤××¤ ×”×—×œ×¤×ª ×ª×¨×’×™×œ (×¨×§ ×¤×¢× ××—×ª!)
        document.getElementById('replaceCancel').onclick = closeReplacePopup;

        document.getElementById('replaceConfirm').onclick = async () => {
            if (!selectedExerciseId) {
                alert("×™×© ×œ×‘×—×•×¨ ×ª×¨×’×™×œ ×œ×¤× ×™ ××™×©×•×¨");
                return;
            }

            const payload = {
                workout_exercise_id: currentItemId,
                exercise_id: selectedExerciseId,
                focus_area_id: null
            };

            console.log("ğŸ“¤ Payload × ×©×œ×—:", payload);

            try {
                const res = await axios({
                    method: 'post',
                    url: 'https://qwyybhjlpgrrxgpaeigp.supabase.co/functions/v1/update-workout-exercise-target',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    data: payload
                });

                console.log("âœ… Response:", res.data);

                closeReplacePopup();
                await fetchWorkoutDetails();

            } catch (err) {
                console.error("âŒ Axios full error:", err);
                alert(
                    "Network Error\n\n" +
                    (err.message || '') +
                    (err.response ? '\nStatus: ' + err.response.status : '')
                );
            }
        };


        fetchWorkoutDetails();
    </script>
</body>

</html>