<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¤×¨×˜×™ ×ª×¨×’×™×œ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    body { background:#f8f9fa; font-family:'Heebo', sans-serif; }

    .card-soft {
      background:#fff;
      border-radius:1rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      padding:1rem 1.25rem;
      margin-bottom:1rem;
      border-right:6px solid #dee2e6;
    }

    /* Exercise layout */
    .exercise-media img { width:100%; border-radius:0.75rem; }

    @media (min-width: 992px) {
      .exercise-layout { display:flex; gap:1.5rem; }
      .exercise-media { flex:0 0 320px; }
      .exercise-text { flex:1; }
    }

    /* History cards (mobile) */
    .history-card {
      background:#fff;
      border-radius:0.75rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      padding:0.75rem 1rem;
      margin-bottom:0.75rem;
    }
    .history-label { color:#6c757d; font-size:0.8rem; }
  </style>
</head>
<body>

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">×¤×¨×˜×™ ×ª×¨×’×™×œ</h3>
    <a href="index.html" class="btn btn-outline-secondary btn-sm">â¬… ×—×–×¨×”</a>
  </div>

  <!-- Exercise details -->
  <div class="card-soft" id="exercise-card">
    <div class="exercise-layout">
      <div class="exercise-text" id="exercise-text">×˜×•×¢×Ÿ...</div>
      <div class="exercise-media mt-3 mt-lg-0" id="exercise-media"></div>
    </div>
  </div>

  <!-- History -->
  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
    <h5 class="mb-0">×”×™×¡×˜×•×¨×™×™×ª ×‘×™×¦×•×¢×™×</h5>
    <div class="d-flex align-items-center gap-2">
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="plannedToggle" checked>
        <label class="form-check-label" for="plannedToggle">×›×•×œ×œ ××ª×•×›× ×Ÿ</label>
      </div>
      <select id="historyLimit" class="form-select form-select-sm" style="width:120px;">
        <option value="10">10 ××—×¨×•× ×™×</option>
        <option value="20" selected>20 ××—×¨×•× ×™×</option>
        <option value="50">50 ××—×¨×•× ×™×</option>
      </select>
    </div>
  </div>
  <div class="text-muted small mb-2" id="historyMeta"></div>

  <!-- Desktop table -->
  <div class="card-soft d-none d-md-block">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>×ª××¨×™×š</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>××™××•×Ÿ</th>
            <th>× ×¤×—</th>
            <th>×¢×•××¡</th>
            <th>×”×¢×¨×•×ª</th>
          </tr>
        </thead>
        <tbody id="history-table"></tbody>
      </table>
    </div>
  </div>

  <!-- Mobile cards -->
  <div id="history-cards" class="d-md-none"></div>

</div>

<script>
  const SUPABASE_PROJECT_REF = "qwyybhjlpgrrxgpaeigp";
  const ENDPOINT = `https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/get-exercise-details`;

  const params = new URLSearchParams(window.location.search);
  const exerciseId = params.get("exercise_id");

  function heDate(d){ return d ? new Date(d).toLocaleDateString("he-IL") : "â€”"; }
  function esc(s){ return s==null ? "" : String(s).replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  async function loadData(){
    const includePlanned = document.getElementById("plannedToggle")?.checked ?? true;
    const limit = Number(document.getElementById("historyLimit")?.value || 20);
    const res = await axios.get(`${ENDPOINT}?exercise_id=${exerciseId}&include_planned=${includePlanned}&limit=${limit}&offset=0&_=${Date.now()}`);
    const ex = res.data.exercise;
    const history = res.data.history || [];

    /* Exercise full details */
    document.getElementById("exercise-text").innerHTML = `
      <h5 class="mb-1">${esc(ex.name_he)}</h5>
      ${ex.name_en ? `<div class="text-muted">${esc(ex.name_en)}</div>` : ""}
      <div class="mt-2">ğŸ¯ ××–×•×¨ ××™×§×•×“: <strong>${esc(ex.focus_areas?.name_he)}</strong></div>
      <div class="text-muted small">Focus ID: ${ex.focus_area_id} â€¢ Workout Type ID: ${ex.focus_areas?.workout_type_id}</div>
      <div class="mt-1">${ex.is_unilateral ? "âœ… ×—×“Ö¾×¦×“×“×™" : "âŒ ×“×•Ö¾×¦×“×“×™"}</div>

      ${ex.default_instructions ? `<div class="mt-3"><strong>ğŸ“‹ ×”× ×—×™×•×ª</strong><div>${esc(ex.default_instructions)}</div></div>` : ""}
      ${ex.professional_notes ? `<div class="mt-3"><strong>ğŸ§  ×”×¢×¨×•×ª ××§×¦×•×¢×™×•×ª</strong><div>${esc(ex.professional_notes)}</div></div>` : ""}
      ${ex.is_deleted ? `<div class="mt-2 text-danger small">×ª×¨×’×™×œ ××¡×•××Ÿ ×›××—×•×§ ×œ×•×’×™×ª</div>` : ""}
    `;

    document.getElementById("exercise-media").innerHTML =
      ex.default_gif_url ? `<img src="${esc(ex.default_gif_url)}" alt="${esc(ex.name_he)}">` : "";

    /* Desktop table */
    document.getElementById("history-table").innerHTML = history.map(h=>{
      const vol = h.reps_per_set != null
        ? `${h.sets ?? "â€”"}Ã—${h.reps_per_set}`
        : (h.time_per_set_seconds != null ? `${h.sets ?? "â€”"}Ã—${h.time_per_set_seconds} ×©× ×³` : "â€”");

      const link = h.workout_id
        ? `<a href="workout.html?id=${encodeURIComponent(h.workout_id)}">${esc(h.workout_name || ("××™××•×Ÿ #" + h.workout_id))}</a>`
        : esc(h.workout_name || "");

      return `
        <tr>
          <td>${heDate(h.workout_date)}</td>
          <td><span class="badge ${h.state==="×‘×•×¦×¢"?"bg-success":"bg-secondary"}">${esc(h.state)}</span></td>
          <td>${link}</td>
          <td>${vol}</td>
          <td>${esc(h.load_used || "â€”")}</td>
          <td>${esc(h.notes || "")}</td>
        </tr>
      `;
    }).join("");

    /* Mobile cards */
    document.getElementById("history-cards").innerHTML = history.map(h=>{
      const vol = h.reps_per_set != null
        ? `${h.sets ?? "â€”"}Ã—${h.reps_per_set}`
        : (h.time_per_set_seconds != null ? `${h.sets ?? "â€”"}Ã—${h.time_per_set_seconds} ×©× ×³` : "â€”");

    // Meta (count)
    const total = res.data.total_history ?? history.length;
    const shown = history.length;
    const metaEl = document.getElementById("historyMeta");
    if (metaEl) metaEl.textContent = `××•×¦×’×•×ª ${shown} ×¨×©×•××•×ª${total != null ? ` ××ª×•×š ${total}` : ""}`;


      const link = h.workout_id
        ? `<a href="workout.html?id=${encodeURIComponent(h.workout_id)}" class="text-decoration-none">${esc(h.workout_name || ("××™××•×Ÿ #" + h.workout_id))}</a>`
        : esc(h.workout_name || "");

      return `
        <div class="history-card">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <strong>${heDate(h.workout_date)}</strong>
            <span class="badge ${h.state==="×‘×•×¦×¢"?"bg-success":"bg-secondary"}">${esc(h.state)}</span>
          </div>

          <div class="mb-1">${link}</div>

          <div class="d-flex gap-3">
            <div>
              <div class="history-label">× ×¤×—</div>
              ${vol}
            </div>
            <div>
              <div class="history-label">×¢×•××¡</div>
              ${esc(h.load_used || "â€”")}
            </div>
          </div>

          ${h.notes ? `<div class="mt-2"><div class="history-label">×”×¢×¨×•×ª</div>${esc(h.notes)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  document.addEventListener("change", (e) => {
    if (e.target && (e.target.id === "plannedToggle" || e.target.id === "historyLimit")) {
      if (exerciseId) loadData();
    }
  });

  if(exerciseId) loadData();
</script>

</body>
</html>
